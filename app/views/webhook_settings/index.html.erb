<h2><%= l(:label_webhook_settings) %></h2>

<%= form_for @webhook_config, url: update_project_webhook_settings_path(@project), method: :put, html: { class: 'webhook-settings' } do |f| %>
  <%= error_messages_for @webhook_config %>

  <div class="box tabular">
    <p>
      <%= f.check_box :enabled %>
      <%= f.label :enabled, l(:label_webhook_enabled) %>
    </p>

    <p>
      <%= f.label :webhook_url, l(:label_webhook_url) %>
      <%= f.text_field :webhook_url, :size => 60 %>
      <em class="info"><%= l(:text_webhook_url_info) %></em>
    </p>

    <p>
      <%= f.label :secret_token, l(:label_webhook_secret_token) %>
      <%= f.text_field :secret_token, :size => 60 %>
      <em class="info"><%= l(:text_webhook_secret_token_info) %></em>
    </p>
  </div>

  <fieldset class="box">
    <legend><%= l(:label_status_templates) %></legend>
    <div style="margin-bottom: 15px;">
      <p class="info"><%= l(:text_status_templates_info) %></p>
      
      <details style="margin-top: 10px; border: 1px solid #ddd; padding: 10px;">
        <summary style="cursor: pointer; color: #0055aa; font-weight: bold;">ğŸ“‹ ç‚¹å‡»æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å ä½ç¬¦åŠè¯´æ˜</summary>
        <div style="margin-top: 15px; overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
            <thead>
              <tr style="background-color: #f5f5f5;">
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">å ä½ç¬¦</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">è¯´æ˜</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">ç¤ºä¾‹å€¼</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="border: 1px solid #ddd; padding: 8px; font-family: monospace;"><code>${user}</code></td>
                <td style="border: 1px solid #ddd; padding: 8px;">æ“ä½œç”¨æˆ·åï¼ˆæ‰§è¡ŒçŠ¶æ€å˜æ›´çš„ç”¨æˆ·ï¼‰</td>
                <td style="border: 1px solid #ddd; padding: 8px; color: #666;">å¼ ä¸‰</td>
              </tr>
              <tr style="background-color: #f9f9f9;">
                <td style="border: 1px solid #ddd; padding: 8px; font-family: monospace;"><code>${task}</code></td>
                <td style="border: 1px solid #ddd; padding: 8px;">ä»»åŠ¡æ ‡é¢˜</td>
                <td style="border: 1px solid #ddd; padding: 8px; color: #666;">ä¿®å¤ç™»å½•é¡µé¢bug</td>
              </tr>
              <tr>
                <td style="border: 1px solid #ddd; padding: 8px; font-family: monospace;"><code>${status}</code></td>
                <td style="border: 1px solid #ddd; padding: 8px;">å½“å‰ä»»åŠ¡çŠ¶æ€</td>
                <td style="border: 1px solid #ddd; padding: 8px; color: #666;">è¿›è¡Œä¸­ã€å·²è§£å†³ã€å·²å…³é—­</td>
              </tr>
              <tr style="background-color: #f9f9f9;">
                <td style="border: 1px solid #ddd; padding: 8px; font-family: monospace;"><code>${project}</code></td>
                <td style="border: 1px solid #ddd; padding: 8px;">é¡¹ç›®åç§°</td>
                <td style="border: 1px solid #ddd; padding: 8px; color: #666;">ç½‘ç«™å¼€å‘é¡¹ç›®</td>
              </tr>
              <tr>
                <td style="border: 1px solid #ddd; padding: 8px; font-family: monospace;"><code>${url}</code></td>
                <td style="border: 1px solid #ddd; padding: 8px;">ä»»åŠ¡è¯¦æƒ…é¡µå®Œæ•´è®¿é—®URL</td>
                <td style="border: 1px solid #ddd; padding: 8px; color: #666;"><code>http://redmine.example.com/issues/123</code></td>
              </tr>
              <tr style="background-color: #f9f9f9;">
                <td style="border: 1px solid #ddd; padding: 8px; font-family: monospace;"><code>${notes}</code></td>
                <td style="border: 1px solid #ddd; padding: 8px;">å¤‡æ³¨ä¿¡æ¯ï¼ˆçŠ¶æ€å˜æ›´æ—¶å¡«å†™çš„å¤‡æ³¨ï¼‰</td>
                <td style="border: 1px solid #ddd; padding: 8px; color: #666;">å·²ä¿®å¤ç™»å½•éªŒè¯é—®é¢˜</td>
              </tr>
              <tr>
                <td style="border: 1px solid #ddd; padding: 8px; font-family: monospace;"><code>${priority}</code></td>
                <td style="border: 1px solid #ddd; padding: 8px;">ä»»åŠ¡ä¼˜å…ˆçº§</td>
                <td style="border: 1px solid #ddd; padding: 8px; color: #666;">ç´§æ€¥ã€é«˜ã€æ­£å¸¸ã€ä½</td>
              </tr>
              <tr style="background-color: #f9f9f9;">
                <td style="border: 1px solid #ddd; padding: 8px; font-family: monospace;"><code>${tracker}</code></td>
                <td style="border: 1px solid #ddd; padding: 8px;">è·Ÿè¸ªæ ‡ç­¾ç±»å‹</td>
                <td style="border: 1px solid #ddd; padding: 8px; color: #666;">Bugã€åŠŸèƒ½ã€æ”¯æŒ</td>
              </tr>
              <tr>
                <td style="border: 1px solid #ddd; padding: 8px; font-family: monospace;"><code>${assigned_to}</code></td>
                <td style="border: 1px solid #ddd; padding: 8px;">ä»»åŠ¡æŒ‡æ´¾äººåç§°ï¼ˆå¦‚æœæœªæŒ‡æ´¾æ˜¾ç¤º"æœªæŒ‡æ´¾"ï¼‰</td>
                <td style="border: 1px solid #ddd; padding: 8px; color: #666;">æå››</td>
              </tr>
            </tbody>
          </table>
          
          <div style="margin-top: 15px; padding: 10px; background-color: #e8f4f8; border-left: 4px solid #2196F3;">
            <p style="margin: 0; font-weight: bold;">ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
            <pre style="margin: 10px 0 0 0; padding: 10px; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 3px; font-size: 0.9em; overflow-x: auto;"><code>${user} å°†ä»»åŠ¡ "${task}" çš„çŠ¶æ€æ›´æ–°ä¸º ${status}
æŒ‡æ´¾äººï¼š${assigned_to}
é¡¹ç›®ï¼š${project}
è¯¦æƒ…ï¼š${url}</code></pre>
          </div>
        </div>
      </details>
    </div>
    
    <div class="box" style="margin-bottom: 20px; border: 1px solid #ccc; padding: 10px;">
      <h3 style="margin-top: 0;"><%= l(:label_enabled_statuses) %></h3>
      <p class="info"><%= l(:text_enabled_statuses_info) %></p>
      <div style="margin-bottom: 10px;">
        <button type="button" onclick="toggleAllStatuses(true)" class="button-small">å…¨é€‰</button>
        <button type="button" onclick="toggleAllStatuses(false)" class="button-small">å…¨ä¸é€‰</button>
        <span style="margin-left: 10px; color: #666; font-size: 0.9em;">å¿…é¡»è‡³å°‘å‹¾é€‰ä¸€ä¸ªçŠ¶æ€</span>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; padding: 10px;">
        <% @issue_statuses.each do |status| %>
          <label style="display: flex; align-items: center;">
            <%= check_box_tag "webhook_config[enabled_statuses][]",
                status.name,
                @webhook_config.enabled_statuses&.include?(status.name),
                :id => "enabled_status_#{status.id}",
                :name => "webhook_config[enabled_statuses][]" %>
            <span style="margin-left: 5px;"><%= status.name %></span>
          </label>
        <% end %>
      </div>
      
      <!-- éšè—å­—æ®µï¼Œç¡®ä¿å³ä½¿æ²¡æœ‰å‹¾é€‰ä»»ä½•çŠ¶æ€ä¹Ÿèƒ½æäº¤ç©ºæ•°ç»„ -->
      <%= hidden_field_tag "webhook_config[enabled_statuses][]", "", :id => "enabled_status_empty" %>
    </div>
    
    <!-- å­é¡¹ç›®åŒæ­¥æ¨¡å— -->
    <div class="box" style="margin-bottom: 20px; border: 1px solid #ccc; padding: 10px;">
      <h3 style="margin-top: 0;"><%= l(:label_sync_sub_projects) %></h3>
      <p class="info"><%= l(:text_sync_sub_projects_info) %></p>
      
      <% if @sub_projects.any? %>
        <div style="margin-bottom: 10px;">
          <button type="button" onclick="toggleAllSubProjects(true)" class="button-small"><%= l(:button_select_all) %></button>
          <button type="button" onclick="toggleAllSubProjects(false)" class="button-small"><%= l(:button_select_none) %></button>
          <span style="margin-left: 10px; color: #666; font-size: 0.9em;"><%= l(:text_sub_projects_hint) %></span>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; padding: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #eee;">
          <% @sub_projects.each do |project| %>
            <label style="display: flex; align-items: center; padding: 5px;">
              <%= check_box_tag "sub_project_ids[]",
                  project.id,
                  project.has_webhook_config,
                  :id => "sub_project_#{project.id}",
                  :name => "sub_project_ids[]" %>
              <span style="margin-left: 5px; font-size: 0.9em;"><%= project.name %></span>
            </label>
          <% end %>
        </div>
      <% else %>
        <p style="color: #666; font-style: italic; margin: 10px 0;"><%= l(:text_no_sub_projects) %></p>
      <% end %>
    </div>
    
    <div style="margin-bottom: 15px; padding: 10px; background-color: #fff3cd; border-left: 4px solid #ffc107; border-radius: 3px;">
      <p style="margin: 0; font-weight: bold; color: #856404;">ğŸ’¡ é‡è¦æç¤ºï¼šå…³äº@åŠŸèƒ½</p>
      <p style="margin: 5px 0 0 0; color: #856404; font-size: 0.9em;">
        â€¢ å¦‚éœ€å®ç°çœŸæ­£çš„é’‰é’‰@åŠŸèƒ½ï¼Œéœ€å®‰è£… 
        <strong style="color: #d39e00;">redmine_users</strong> æ’ä»¶ä»¥è·å–ç”¨æˆ·æ‰‹æœºå·<br>
        â€¢ æŒ‡æ´¾äººä¿¡æ¯éœ€è¦åœ¨usersè¡¨ä¸­å­˜åœ¨phoneå­—æ®µå¹¶å¡«å†™æ‰‹æœºå·<br>
        â€¢ æœªå®‰è£…redmine_usersæ’ä»¶æ—¶ï¼Œä»…æ˜¾ç¤º@æ˜µç§°ï¼Œæ— æ³•çœŸæ­£@æé†’
      </p>
    </div>
    
    <table class="list">
      <thead>
        <tr>
          <th style="width: 150px;"><%= l(:label_issue_status) %></th>
          <th><%= l(:label_notification_template) %></th>
        </tr>
      </thead>
      <tbody>
        <% @issue_statuses.each do |status| %>
          <tr>
            <td>
              <label for="enabled_status_<%= status.id %>" style="cursor: pointer;">
                <%= status.name %>
              </label>
            </td>
            <td>
              <%= text_area_tag "webhook_config[status_templates][#{status.name}]",
                  @webhook_config.status_template(status.name) || default_template(status),
                  :rows => 3,
                  :cols => 80,
                  :placeholder => l(:placeholder_notification_template),
                  :class => 'template-input',
                  :style => 'width: 100%; box-sizing: border-box;' %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </fieldset>

  <p style="margin-top: 20px;">
    <%= f.submit l(:button_save), :class => 'button-positive' %>
  </p>
<% end %>

<script>
  function toggleAllStatuses(checked) {
    var checkboxes = document.querySelectorAll('input[name="webhook_config[enabled_statuses][]"]');
    for (var i = 0; i < checkboxes.length; i++) {
      checkboxes[i].checked = checked;
    }
  }
  
  function toggleAllSubProjects(checked) {
    var checkboxes = document.querySelectorAll('input[name="sub_project_ids[]"]');
    for (var i = 0; i < checkboxes.length; i++) {
      checkboxes[i].checked = checked;
    }
  }
</script>

<style>
  .info {
    color: #666;
    font-size: 0.9em;
    margin-left: 10px;
  }
  table.list input[type="text"] {
    width: 100%;
    box-sizing: border-box;
  }
</style>

<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'webhook', :plugin => 'redmine_webhook' %>
  
  <%# ä¿®å¤èœå•é«˜äº® - ä½¿ç”¨æ›´å¯é çš„æ–¹å¼ %>
  <%= javascript_tag do %>
    (function() {
      'use strict';
      
      function highlightWebhookMenu() {
        // ç­‰å¾…Redmineèœå•åˆå§‹åŒ–å®Œæˆ
        setTimeout(function() {
          var mainMenu = document.getElementById('main-menu');
          if (!mainMenu) {
            console.warn('[Webhook] Main menu not found');
            return;
          }
          
          // æŸ¥æ‰¾webhookèœå•é“¾æ¥
          var webhookLink = mainMenu.querySelector('a.webhook');
          if (!webhookLink) {
            console.warn('[Webhook] Webhook menu link not found');
            return;
          }
          
          console.log('[Webhook] Found webhook menu link:', webhookLink);
          
          // ç§»é™¤æ‰€æœ‰ç°æœ‰çš„selectedç±»
          mainMenu.querySelectorAll('li.selected').forEach(function(li) {
            li.classList.remove('selected');
          });
          mainMenu.querySelectorAll('a.selected').forEach(function(a) {
            a.classList.remove('selected');
          });
          
          // ä¸ºwebhooké“¾æ¥æ·»åŠ selectedç±»
          webhookLink.classList.add('selected');
          console.log('[Webhook] Added selected class to webhook link');
          
          // ä¸ºçˆ¶çº§liæ·»åŠ selectedç±»
          var parentLi = webhookLink.closest('li');
          if (parentLi) {
            parentLi.classList.add('selected');
            console.log('[Webhook] Added selected class to parent li');
          }
          
          // å¦‚æœwebhookåœ¨dropdownä¸­ï¼Œä¹Ÿé«˜äº®çˆ¶çº§èœå•é¡¹
          var dropdownParent = webhookLink.closest('li.has-children');
          if (dropdownParent) {
            dropdownParent.classList.add('selected');
            console.log('[Webhook] Added selected class to dropdown parent');
          }
        }, 100); // å»¶æ—¶100msç¡®ä¿Redmineèœå•åˆå§‹åŒ–å®Œæˆ
      }
      
      // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', highlightWebhookMenu);
      } else {
        highlightWebhookMenu();
      }
      
      // ç›‘å¬Turbo/Turbolinksäº‹ä»¶ï¼ˆå¦‚æœRedmineä½¿ç”¨ï¼‰
      if (typeof Turbo !== 'undefined') {
        document.addEventListener('turbo:load', highlightWebhookMenu);
      } else if (typeof Turbolinks !== 'undefined') {
        document.addEventListener('turbolinks:load', highlightWebhookMenu);
      }
    })();
  <% end %>
<% end %>